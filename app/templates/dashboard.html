{% extends "base.html" %}

{% block title %}Dashboard - SSH Key Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                DB Size
            </div>
            <div class="card-body">
                <h5 class="card-title" id="db-size">{{ data.db_size }} MB</h5>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                Logged-in Admin Users
            </div>
            <div class="card-body">
                <ul>
                    {% for admin in data.logged_in_admins %}
                    <li>{{ admin }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="row mt-3 g-3">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5>Total API Requests</h5>
                <select class="form-select" id="global-period">
                    <option value="1h" {% if data.period == '1h' %}selected{% endif %}>Last 1 Hour</option>
                    <option value="6h" {% if data.period == '6h' %}selected{% endif %}>Last 6 Hours</option>
                    <option value="12h" {% if data.period == '12h' %}selected{% endif %}>Last 12 Hours</option>
                    <option value="24h" {% if data.period == '24h' %}selected{% endif %}>Last 24 Hours</option>
                </select>
            </div>
            <div class="card-body">
                <h5 class="card-title" id="total-requests">{{ data.total_requests }}</h5>
                <p id="successful-requests">Successful Requests: {{ data.successful_requests }}</p>
                <p id="failed-requests">Failed Requests: {{ data.failed_requests }}</p>
            </div>
        </div>
    </div>
</div>
<div class="row mt-3">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5>Top 5 Successful API Users</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody id="top-users">
                        {% for user in data.top_users %}
                        <tr>
                            <td>{{ user.name }}</td>
                            <td>{{ user.success_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5>Top 5 API Servers</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody id="top-servers">
                        {% for server in data.top_servers %}
                        <tr>
                            <td>{{ server.name }}</td>
                            <td>{{ server.request_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5>Top 5 Failed API Users</h5>
            </div>
            <div class="card-body">
                <table class="table">
                    <tbody id="top-failed-users">
                        {% for user in data.top_failed_users %}
                        <tr>
                            <td>{{ user.name }}</td>
                            <td>{{ user.failure_count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script>
    const fetchDashboardData = (url, updateFunction) => {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateFunction(data);
            });
    };

    document.getElementById('global-period').addEventListener('change', function() {
        const period = this.value;
        fetchDashboardData(`/admin/dashboard-data?period_api=${period}`, data => {
            document.getElementById('db-size').textContent = data.db_size + ' MB';
            document.getElementById('total-requests').textContent = data.total_requests;
            document.getElementById('successful-requests').textContent = `Successful Requests: ${data.successful_requests}`;
            document.getElementById('failed-requests').textContent = `Failed Requests: ${data.failed_requests}`;
            const ul = document.querySelector('.card-body ul');
            ul.innerHTML = '';
            data.logged_in_admins.forEach(admin => {
                const li = document.createElement('li');
                li.textContent = admin;
                ul.appendChild(li);
            });
            const tbodyUsers = document.getElementById('top-users');
            tbodyUsers.innerHTML = '';
            data.top_users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${user.name}</td><td>${user.success_count}</td>`;
                tbodyUsers.appendChild(tr);
            });
            const tbodyServers = document.getElementById('top-servers');
            tbodyServers.innerHTML = '';
            data.top_servers.forEach(server => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${server.name}</td><td>${server.request_count}</td>`;
                tbodyServers.appendChild(tr);
            });
            const tbodyFailedUsers = document.getElementById('top-failed-users');
            tbodyFailedUsers.innerHTML = '';
            data.top_failed_users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${user.name}</td><td>${user.failure_count}</td>`;
                tbodyFailedUsers.appendChild(tr);
            });
        });
    });
    
    document.addEventListener("DOMContentLoaded", function() {
        // Simulate initial data load
        document.getElementById('global-period').dispatchEvent(new Event('change'));
    });
</script>
{% endblock %}